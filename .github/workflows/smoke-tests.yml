name: Smoke Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  smoke-test:
    name: Smoke Test
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
    
    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Build release
      run: cargo build --release
    
    - name: Test version command
      run: |
        ./target/release/curlgenerator${{ matrix.os == 'windows-latest' && '.exe' || '' }} --version
    
    - name: Test help command
      run: |
        ./target/release/curlgenerator${{ matrix.os == 'windows-latest' && '.exe' || '' }} --help
    
    - name: Test Petstore v3 generation (PowerShell)
      run: |
        ./target/release/curlgenerator${{ matrix.os == 'windows-latest' && '.exe' || '' }} \
          https://petstore3.swagger.io/api/v3/openapi.json \
          --output ./test-output-ps \
          --skip-validation
    
    - name: Verify PowerShell scripts were generated
      run: |
        ls -la ./test-output-ps
        [ -f "./test-output-ps/POSTAddPet.ps1" ] || exit 1
        [ -f "./test-output-ps/GETGetPetById.ps1" ] || exit 1
      shell: bash
    
    - name: Test Petstore v3 generation (Bash)
      run: |
        ./target/release/curlgenerator${{ matrix.os == 'windows-latest' && '.exe' || '' }} \
          https://petstore3.swagger.io/api/v3/openapi.json \
          --output ./test-output-sh \
          --skip-validation \
          --bash
    
    - name: Verify Bash scripts were generated
      run: |
        ls -la ./test-output-sh
        [ -f "./test-output-sh/POSTAddPet.sh" ] || exit 1
        [ -f "./test-output-sh/GETGetPetById.sh" ] || exit 1
      shell: bash
    
    - name: Test with custom base URL
      run: |
        ./target/release/curlgenerator${{ matrix.os == 'windows-latest' && '.exe' || '' }} \
          https://petstore3.swagger.io/api/v3/openapi.json \
          --output ./test-output-custom \
          --skip-validation \
          --base-url https://custom.example.com
    
    - name: Verify custom base URL in generated script
      run: |
        grep -q "https://custom.example.com" ./test-output-custom/GETGetPetById.ps1 || exit 1
      shell: bash
    
    - name: Test with authorization header
      run: |
        ./target/release/curlgenerator${{ matrix.os == 'windows-latest' && '.exe' || '' }} \
          https://petstore3.swagger.io/api/v3/openapi.json \
          --output ./test-output-auth \
          --skip-validation \
          --authorization-header "Bearer test-token"
    
    - name: Verify authorization header in generated script
      run: |
        grep -q "Authorization.*Bearer test-token" ./test-output-auth/POSTAddPet.ps1 || exit 1
      shell: bash
    
    - name: Clean up test outputs
      if: always()
      run: |
        rm -rf ./test-output-*
      shell: bash
